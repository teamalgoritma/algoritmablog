<!DOCTYPE HTML>

<html>
    <head>
        <script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "/"
        },
        "articleSection" : "blog",
        "name" : "Creating Choropleth with Mapshaper and R",
        "headline" : "Creating Choropleth with Mapshaper and R",
        "description" : "Geospatial is one of the important things in data processing. With geospatial, we can provide information only with the help of maps so that information can be conveyed properly.
There are many types of geospatial that we can do, such as Dot Map, Connection Map, Choropleth, Hexbin Map, and Bubble Map1. Each type of geospatial has its own function, and each of these types also requires different types of information/data.",
        "inLanguage" : "en",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2019",
        "datePublished": "2019-08-18 00:00:00 &#43;0000 UTC",
        "dateModified" : "2019-08-18 00:00:00 &#43;0000 UTC",
        "url" : "/blog/creating-choropleth-with-mapshaper-and-r/",
        "wordCount" : "2610",
        "keywords" : [ "Geocoding","Mapshaper","Leaflet","Map","Data Visualization","Blog" ]
    }
    </script>
        
            
                <title>Creating Choropleth with Mapshaper and R</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.54.0" />
        


        
            <meta name="author" content="Ardhito Utomo">
        
        
            
                <meta name="description" content="HTML5 UP theme, Future Imperfect with some extra goodies, ported by Julio Pescador. Powered by Hugo">
            
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Creating Choropleth with Mapshaper and R"/>
<meta name="twitter:description" content="Geospatial is one of the important things in data processing. With geospatial, we can provide information only with the help of maps so that information can be conveyed properly.
There are many types of geospatial that we can do, such as Dot Map, Connection Map, Choropleth, Hexbin Map, and Bubble Map1. Each type of geospatial has its own function, and each of these types also requires different types of information/data."/>
<meta name="twitter:site" content="@teamalgoritma"/>

        <meta property="og:title" content="Creating Choropleth with Mapshaper and R" />
<meta property="og:description" content="Geospatial is one of the important things in data processing. With geospatial, we can provide information only with the help of maps so that information can be conveyed properly.
There are many types of geospatial that we can do, such as Dot Map, Connection Map, Choropleth, Hexbin Map, and Bubble Map1. Each type of geospatial has its own function, and each of these types also requires different types of information/data." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/creating-choropleth-with-mapshaper-and-r/" />
<meta property="article:published_time" content="2019-08-18T00:00:00&#43;00:00"/>
<meta property="article:modified_time" content="2019-08-18T00:00:00&#43;00:00"/>

        <meta property="og:image" content="//images/logo.png">
        <meta property="og:image:type" content="image/png">
        <meta property="og:image:width" content="512">
        <meta property="og:image:height" content="512">
        
<meta itemprop="name" content="Creating Choropleth with Mapshaper and R">
<meta itemprop="description" content="Geospatial is one of the important things in data processing. With geospatial, we can provide information only with the help of maps so that information can be conveyed properly.
There are many types of geospatial that we can do, such as Dot Map, Connection Map, Choropleth, Hexbin Map, and Bubble Map1. Each type of geospatial has its own function, and each of these types also requires different types of information/data.">


<meta itemprop="datePublished" content="2019-08-18T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-08-18T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2610">



<meta itemprop="keywords" content="Geocoding,Mapshaper,Leaflet,Map,Data Visualization," />

        

        
            
        

        
        
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
            <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700">
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css">
            <link rel="stylesheet" href="/css/main.css">
            <link rel="stylesheet" href="/css/add-on.css">
            <link rel="stylesheet" href="/css/academicons.min.css">
        

        
            
                
            
                
                    <link rel="stylesheet" href="/css/monokai-sublime.css">
                
            
        


  
    
      <link rel="stylesheet" href="/css/monokai-sublime.css" rel="stylesheet" id="theme-stylesheet">
      <script src="/js/highlight.pack.js"></script>
      <script>hljs.initHighlightingOnLoad();</script>
  


      





    </head>
    <body>

      
      <div id="wrapper">

    
    
<header id="header">
    
      <h1><a href="/">blog</a></h1>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/">
                            <i class="fa fa-home">&nbsp;</i>Home
                    </a>
                </li>
            
                <li>
                    <a href="/about/">
                            <i class="fa fa-id-card-o">&nbsp;</i>About
                    </a>
                </li>
            
                <li>
                    <a href="/tags/machine-learning/">
                            <i class="fa fa-cog">&nbsp;</i>Machine Learning
                    </a>
                </li>
            
                <li>
                    <a href="/tags/data-visualization/">
                            <i class="fa fa-area-chart">&nbsp;</i>Data Visualization
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="as_sitesearch" value="/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="as_sitesearch" value="/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/">
                            <h3>
                                <i class="fa fa-home">&nbsp;</i>Home
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about/">
                            <h3>
                                <i class="fa fa-id-card-o">&nbsp;</i>About
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags/machine-learning/">
                            <h3>
                                <i class="fa fa-cog">&nbsp;</i>Machine Learning
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags/data-visualization/">
                            <h3>
                                <i class="fa fa-area-chart">&nbsp;</i>Data Visualization
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section class="recent-posts">
            <div class="mini-posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                

                
                    
                

                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/ridge-lasso/">Ridge and LASSO Regression</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-12-18'>
                                    December 18, 2019</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/poisson-regression-and-negative-binomial-regression/">Poisson Regression and Negative Binomial Regression</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-10-22'>
                                    October 22, 2019</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/tidymodels/">Introduction to tidymodels</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-10-06'>
                                    October 6, 2019</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/creating-choropleth-with-mapshaper-and-r/">Creating Choropleth with Mapshaper and R</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-08-18'>
                                    August 18, 2019</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/self-organizing-maps/">Self-Organizing Maps</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-04-26'>
                                    April 26, 2019</time>
                            </header>
                            

                        </article>
                

                
                    <a href=
                        
                            /blog/
                        
                        class="button">View more posts</a>
                
            </div>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            



<li>
  <a href="//twitter.com/share?url=%2fblog%2fcreating-choropleth-with-mapshaper-and-r%2f&amp;text=Creating%20Choropleth%20with%20Mapshaper%20and%20R&amp;via=teamalgoritma" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>








<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=%2fblog%2fcreating-choropleth-with-mapshaper-and-r%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
    </a>
</li>







<li>
  <a href="//www.linkedin.com/shareArticle?url=%2fblog%2fcreating-choropleth-with-mapshaper-and-r%2f&amp;title=Creating%20Choropleth%20with%20Mapshaper%20and%20R" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>











        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
  <header>
    <div class="title">
        
            <h2><a href="/blog/creating-choropleth-with-mapshaper-and-r/">Creating Choropleth with Mapshaper and R</a></h2>
        
        
    </div>
    <div class="meta">
        

        <time class="published"
            datetime='2019-08-18'>
            August 18, 2019</time>
        <span class="author">Ardhito Utomo</span>
        
            <p>13 minute read</p>
        
        
    </div>
</header>


  
    <section id="social-share">
      <ul class="icons">
        



<li>
  <a href="//twitter.com/share?url=%2fblog%2fcreating-choropleth-with-mapshaper-and-r%2f&amp;text=Creating%20Choropleth%20with%20Mapshaper%20and%20R&amp;via=teamalgoritma" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>








<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=%2fblog%2fcreating-choropleth-with-mapshaper-and-r%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
    </a>
</li>







<li>
  <a href="//www.linkedin.com/shareArticle?url=%2fblog%2fcreating-choropleth-with-mapshaper-and-r%2f&amp;title=Creating%20Choropleth%20with%20Mapshaper%20and%20R" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>











      </ul>
    </section>
  

  

  <div id="content">
    

<p><em>Geospatial</em> is one of the important things in data processing. With <em>geospatial</em>, we can provide information only with the help of maps so that information can be conveyed properly.</p>

<p>There are many types of <em>geospatial</em> that we can do, such as <em>Dot Map</em>, <em>Connection Map</em>, <em>Choropleth</em>, <em>Hexbin Map</em>, and <em>Bubble Map</em><sup class="footnote-ref" id="fnref:note-1"><a href="#fn:note-1">1</a></sup>. Each type of geospatial has its own function, and each of these types also requires different types of information/data.</p>

<p>This time, we will learn about one form of geocoding which is <strong>choropleth</strong>. Our pursuit of this material:</p>

<ul>
<li>Retrieving Data

<ul>
<li>Using <strong>Shapefile</strong></li>
<li>Types of data used</li>
<li>Introduction to <strong>mapshaper</strong></li>
<li>Choose the data you want to focus on</li>
<li>Reading <code>.json</code> data</li>
<li>Using <code>.rds</code></li>
</ul></li>
<li>Processing Data

<ul>
<li>Hydrant Data</li>
<li>Data Merge</li>
</ul></li>
<li>Presenting Data with <code>leaflet</code></li>
</ul>

<h2 id="retrieving-data">Retrieving Data</h2>

<pre><code class="language-r">library(prettydoc)
library(tidyverse)
library(ggplot2)
library(leaflet)
library(geojsonio)
library(htmlwidgets)
library(htmltools)
</code></pre>

<p>First of all, we would like to download the data from <a href="https://gadm.org/download_country_v3.html">GADM</a>. We will focus on <strong>Indonesia</strong>. In data retrieval, there are two ways we can do it: process the file as a Shapefile data type first, or directly process it using R with <code>.rds</code> data. We could also read the entire data using the <code>readOGR</code> function from the <code>rgdal</code> package, but we won&rsquo;t discuss that this time.</p>

<h3 id="shapefile-data">Shapefile Data</h3>

<p>Shapefile data is a collection of data used in many <em>geospatial</em> applications. The advantage of Shapefile data is that besides being accessible in many map processing applications, Shapefile data can also be viewed and processed in <strong>mapshaper</strong> (we will discuss it after this) to ensure the information in it before extracting it as the file we need.</p>

<p>When we look at Shapefile data (<code>.shp</code>) that we have downloaded from GADM, we can see that each section is divided into several files at once <sup class="footnote-ref" id="fnref:note-2"><a href="#fn:note-2">2</a></sup>:</p>

<ul>
<li><code>.shp</code>: main data containing geometry information (main)</li>
<li><code>.shx</code>: index file of each geometry (main)</li>
<li><code>.dbf</code>: data that contains attributes in each area in the data (main)</li>
<li><code>.prj</code>: file that stores coordinate system information (optional, used in ArcGIS)</li>
<li><code>.cpg</code>: file used to specify the <em>code page</em> to identify the character set used (optional)</li>
</ul>

<p>Because the information that we use is spread to several files at once with different extensions, we have to change it first to one file so that it is more easily accessed/processed in R. For this reason, we will process it first in <a href="https://mapshaper.org/">mapshaper</a>. After some processing and cleaning, we can extract the data in the form of <code>.json</code>.</p>

<p><img src="/img/0.png" style="display: block; margin: auto;" /></p>

<p>Mapshaper will receive some data and collect it at once. From all 5 extensions we from shapefiles, we can put everything except <code>.cpg</code>. We set everything up, we click on the <em>detect intersection path</em> section to confirm whether our data have any <em>intersection</em>/<em>contact point</em> or not, then we <em>import</em>.</p>

<p><img src="/img/1.png" style="display: block; margin: auto;" /></p>

<p>From the results we have imported, we can see that the <code>gadm36_IDN_3</code> data is the data that cuts across the district. In this data, it also happens that the map we get is a &lsquo;good&rsquo; map, because there is no <em>meeting point</em>/<em>intersection</em><sup class="footnote-ref" id="fnref:note-3"><a href="#fn:note-3">3</a></sup>.</p>

<p><img src="/img/2.png" style="display: block; margin: auto;" /></p>

<p><img src="/img/2_intersection.png" style="display: block; margin: auto;" /></p>

<p><img src="/img/2_intersection_zoom.png" style="display: block; margin: auto;" /></p>

<p>After that, we would want to see all information about each area that we have from the data we have imported, by pressing the <code>i</code> button on the top right. We can see that there is information about the country (in the variable <code>NAME_0</code>), provinces (<code>NAME_1</code>), districts/cities (<code>NAME_2</code>), sub-districts (<code>NAME_3</code>), also villages (<code>NAME_4</code>) of each place. In addition, there are IDs for each section, but we will not use them here.</p>

<p>We can directly export it in the form of TopoJSON (similar if not lighter than GeoJSON, and we can use this because our data is clean enough <sup class="footnote-ref" id="fnref:note-4"><a href="#fn:note-4">4</a></sup>). But for now, we will try to select/filter the areas we want to focus on.</p>

<p>In the mapshaper, there is a <em>console</em> that we can use to process map data. We can see commands that we can use with <code>help</code> and see some examples of using console with <code>tips</code>.</p>

<p>We will try to select only in the sub-district (<code>gadm36_IDN_3</code>) and we filter only on the DKI Jakarta area:</p>

<pre><code>filter 'NAME_1 == &quot;Jakarta Raya&quot;'
</code></pre>

<p><img src="/img/3_jakarta_kecamatan.png" style="display: block; margin: auto;" /></p>

<p>After that, we will export the data as TopoJSON by clicking &lsquo;Export&rsquo; at the top right.</p>

<p>Then, to read the <code>.json</code> data in R, we will use the <code>geojsonio</code> package. In the <code>geojson_read</code> function, we specify <code>what = &quot;sp&quot;</code> to make sure the data we read is a spatial class, not <em>list</em>. Due to the data we have from different sources and differences in the &ldquo;Pulau Seribu&rdquo; section (vs. &ldquo;Kep. Seribu&rdquo;), we will omit that section.</p>

<pre><code class="language-r"># Read the data
jakarta_json &lt;- geojson_read(&quot;data_input/clean/gadm36_IDN_3_jkt.json&quot;, what = &quot;sp&quot;)
</code></pre>

<p>If you want to check the data first, you can use <code>@</code> to see the contents of the table</p>

<pre><code class="language-r">head(jakarta_json@data)
</code></pre>

<pre><code>#&gt;     id GID_0    NAME_0   GID_1       NAME_1 NL_NAME_1     GID_2
#&gt; 0 &lt;NA&gt;   IDN Indonesia IDN.7_1 Jakarta Raya           IDN.7.1_1
#&gt; 1 &lt;NA&gt;   IDN Indonesia IDN.7_1 Jakarta Raya           IDN.7.1_1
#&gt; 2 &lt;NA&gt;   IDN Indonesia IDN.7_1 Jakarta Raya           IDN.7.1_1
#&gt; 3 &lt;NA&gt;   IDN Indonesia IDN.7_1 Jakarta Raya           IDN.7.1_1
#&gt; 4 &lt;NA&gt;   IDN Indonesia IDN.7_1 Jakarta Raya           IDN.7.1_1
#&gt; 5 &lt;NA&gt;   IDN Indonesia IDN.7_1 Jakarta Raya           IDN.7.1_1
#&gt;          NAME_2 NL_NAME_2       GID_3           NAME_3 VARNAME_3 NL_NAME_3
#&gt; 0 Jakarta Barat           IDN.7.1.1_1       Cengkareng                    
#&gt; 1 Jakarta Barat           IDN.7.1.2_1 Grogolpetamburan                    
#&gt; 2 Jakarta Barat           IDN.7.1.3_1        Kalideres                    
#&gt; 3 Jakarta Barat           IDN.7.1.4_1       Kebonjeruk                    
#&gt; 4 Jakarta Barat           IDN.7.1.5_1        Kembangan                    
#&gt; 5 Jakarta Barat           IDN.7.1.6_1         Palmerah                    
#&gt;      TYPE_3    ENGTYPE_3    CC_3 HASC_3
#&gt; 0 Kecamatan Sub-district 3174070       
#&gt; 1 Kecamatan Sub-district 3174040       
#&gt; 2 Kecamatan Sub-district 3174080       
#&gt; 3 Kecamatan Sub-district 3174020       
#&gt; 4 Kecamatan Sub-district 3174010       
#&gt; 5 Kecamatan Sub-district 3174030
</code></pre>

<pre><code class="language-r"># Change the data type to `sf`
jakarta_json_mod &lt;- sf::st_as_sf(jakarta_json)

# Removing `Kepulauan Seribu` and some columns we won't use 
jakarta_json_mod &lt;- jakarta_json_mod %&gt;% 
  # Change the name as template
  mutate(NAME_3 = str_replace_all(NAME_3, fixed(&quot; &quot;), &quot;&quot;) %&gt;% str_to_title()) %&gt;%       
  # Removing `Kepulauan Seribu`
  filter(NAME_2 != &quot;Kepulauan Seribu&quot;)  %&gt;%                        
  # Removing some columns
  dplyr::select(-c(id, NL_NAME_1, NL_NAME_2, NL_NAME_3, VARNAME_3, HASC_3, TYPE_3, ENGTYPE_3)) 

glimpse(jakarta_json_mod)
</code></pre>

<pre><code>#&gt; Observations: 45
#&gt; Variables: 10
#&gt; $ GID_0    &lt;fct&gt; IDN, IDN, IDN, IDN, IDN, IDN, IDN, IDN, IDN, IDN, IDN...
#&gt; $ NAME_0   &lt;fct&gt; Indonesia, Indonesia, Indonesia, Indonesia, Indonesia...
#&gt; $ GID_1    &lt;fct&gt; IDN.7_1, IDN.7_1, IDN.7_1, IDN.7_1, IDN.7_1, IDN.7_1,...
#&gt; $ NAME_1   &lt;fct&gt; Jakarta Raya, Jakarta Raya, Jakarta Raya, Jakarta Ray...
#&gt; $ GID_2    &lt;fct&gt; IDN.7.1_1, IDN.7.1_1, IDN.7.1_1, IDN.7.1_1, IDN.7.1_1...
#&gt; $ NAME_2   &lt;fct&gt; Jakarta Barat, Jakarta Barat, Jakarta Barat, Jakarta ...
#&gt; $ GID_3    &lt;fct&gt; IDN.7.1.1_1, IDN.7.1.2_1, IDN.7.1.3_1, IDN.7.1.4_1, I...
#&gt; $ NAME_3   &lt;chr&gt; &quot;Cengkareng&quot;, &quot;Grogolpetamburan&quot;, &quot;Kalideres&quot;, &quot;Kebon...
#&gt; $ CC_3     &lt;fct&gt; 3174070, 3174040, 3174080, 3174020, 3174010, 3174030,...
#&gt; $ geometry &lt;MULTIPOLYGON&gt; MULTIPOLYGON (((106.7004 -6..., MULTIPOLYGON...
</code></pre>

<h3 id="data-rds">Data <code>.rds</code></h3>

<p>For <code>.rds</code> data, we can directly select <code>R(sf)</code> in GADM<sup class="footnote-ref" id="fnref:note-5"><a href="#fn:note-5">5</a></sup>. After that, we can immediately read it.</p>

<pre><code class="language-r">indonesia_rds &lt;- read_rds(&quot;data_input/clean/gadm36_IDN_3_sf.rds&quot;)
</code></pre>

<p>Then because we want to focus on DKI Jakarta, we will process the data first</p>

<pre><code class="language-r">jakarta_rds &lt;- indonesia_rds %&gt;% 
  mutate(NAME_3 = str_replace_all(NAME_3, fixed(&quot; &quot;), &quot;&quot;) %&gt;% str_to_title()) %&gt;%
  filter(NAME_1 == &quot;Jakarta Raya&quot;, NAME_2 != &quot;Kepulauan Seribu&quot;) %&gt;% 
  dplyr::select(-c(NL_NAME_1, NL_NAME_2, NL_NAME_3, VARNAME_3, HASC_3, TYPE_3, ENGTYPE_3))

glimpse(jakarta_rds)
</code></pre>

<pre><code>#&gt; Observations: 45
#&gt; Variables: 10
#&gt; $ GID_0    &lt;chr&gt; &quot;IDN&quot;, &quot;IDN&quot;, &quot;IDN&quot;, &quot;IDN&quot;, &quot;IDN&quot;, &quot;IDN&quot;, &quot;IDN&quot;, &quot;IDN...
#&gt; $ NAME_0   &lt;chr&gt; &quot;Indonesia&quot;, &quot;Indonesia&quot;, &quot;Indonesia&quot;, &quot;Indonesia&quot;, &quot;...
#&gt; $ GID_1    &lt;chr&gt; &quot;IDN.7_1&quot;, &quot;IDN.7_1&quot;, &quot;IDN.7_1&quot;, &quot;IDN.7_1&quot;, &quot;IDN.7_1&quot;...
#&gt; $ NAME_1   &lt;chr&gt; &quot;Jakarta Raya&quot;, &quot;Jakarta Raya&quot;, &quot;Jakarta Raya&quot;, &quot;Jaka...
#&gt; $ GID_2    &lt;chr&gt; &quot;IDN.7.1_1&quot;, &quot;IDN.7.1_1&quot;, &quot;IDN.7.1_1&quot;, &quot;IDN.7.1_1&quot;, &quot;...
#&gt; $ NAME_2   &lt;chr&gt; &quot;Jakarta Barat&quot;, &quot;Jakarta Barat&quot;, &quot;Jakarta Barat&quot;, &quot;J...
#&gt; $ GID_3    &lt;chr&gt; &quot;IDN.7.1.1_1&quot;, &quot;IDN.7.1.2_1&quot;, &quot;IDN.7.1.3_1&quot;, &quot;IDN.7.1...
#&gt; $ NAME_3   &lt;chr&gt; &quot;Cengkareng&quot;, &quot;Grogolpetamburan&quot;, &quot;Kalideres&quot;, &quot;Kebon...
#&gt; $ CC_3     &lt;chr&gt; &quot;3174070&quot;, &quot;3174040&quot;, &quot;3174080&quot;, &quot;3174020&quot;, &quot;3174010&quot;...
#&gt; $ geometry &lt;MULTIPOLYGON [°]&gt; MULTIPOLYGON (((106.7004 -6..., MULTIPOL...
</code></pre>

<p>We can see that both data already contain the same information and with the same class. Please note that the next time we use <code>leaflet</code>, one of the data type they can read is spatial data frames from package <code>lf</code> (see <code>?leaflet</code> for further details).</p>

<pre><code class="language-r">class(jakarta_rds)
</code></pre>

<pre><code>#&gt; [1] &quot;sf&quot;         &quot;data.frame&quot;
</code></pre>

<pre><code class="language-r">class(jakarta_json_mod)
</code></pre>

<pre><code>#&gt; [1] &quot;sf&quot;         &quot;data.frame&quot;
</code></pre>

<p>We can continue to use one of the data we have read previously. This time, we will use the data that had been read earlier through mapshaper (<code>jakarta_json_mod</code>).</p>

<pre><code class="language-r">rm(indonesia_rds, jakarta_rds)
</code></pre>

<h2 id="processing-the-data">Processing The Data</h2>

<p>In the data processing stage, we will try to match the contents of the hydrant data which we will later display the information on the map, with the geometry data that have previously read (and processed). This is done to avoid clashes due to different regional names, and it also more reasonable to do so.</p>

<h3 id="hydrant-data">Hydrant Data</h3>

<p>We will read the hydrant data which contains information about the hydrants scattered in the Greater Jakarta area along with the conditions (Good/Damaged/Missing) and the location name of the area (<strong>not</strong> the location of the hydrant).</p>

<pre><code class="language-r">hidran &lt;- read.csv(&quot;data_input/clean/hidran.csv&quot;)

hidran_mod &lt;- hidran %&gt;% 
  mutate(lokasi = str_replace_all(lokasi, fixed(&quot; &quot;), &quot;&quot;) %&gt;% str_to_title()) %&gt;% 
  filter(wilayah != &quot;Kepulauan Seribu&quot;) 

head(hidran_mod)
</code></pre>

<pre><code>#&gt;   no       wilayah       lokasi kondisi jumlah  latitude longitude
#&gt; 1  1 Jakarta Pusat       Gambir    Baik     20 -6.169115  106.8165
#&gt; 2  2 Jakarta Pusat   Tanahabang    Baik     36 -6.206441  106.8122
#&gt; 3  3 Jakarta Pusat      Menteng    Baik     30 -6.195425  106.8346
#&gt; 4  4 Jakarta Pusat    Joharbaru    Baik     15 -6.185153  106.8575
#&gt; 5  5 Jakarta Pusat Cempakaputih    Baik     21 -6.180330  106.8687
#&gt; 6  6 Jakarta Pusat    Kemayoran    Baik     34 -6.160978  106.8533
</code></pre>

<p>There are several other modifications that will be made:</p>

<ul>
<li>The condition &ldquo;Lost&rdquo;/&ldquo;Hilang&rdquo; will be replaced by &ldquo;Damaged&rdquo;/&ldquo;Rusak&rdquo; due to the &ldquo;Hilang&rdquo; factor gives very little or no contribution to the data</li>
<li>Conditions/&ldquo;kondisi&rdquo; will be added by region and location again so that the level from the original &ldquo;Rusak&rdquo; and &ldquo;Rusak&rdquo; from &ldquo;Hilang&rdquo; can be combined into one factor only</li>
</ul>

<pre><code class="language-r">hidran_mod &lt;- hidran_mod %&gt;% 
  mutate(kondisi = ifelse(kondisi == &quot;Hilang&quot;, &quot;Rusak&quot;, paste(kondisi))) %&gt;% 
  group_by(wilayah, lokasi, kondisi) %&gt;% 
  summarise(jumlah = sum(jumlah)) %&gt;% 
  ungroup()

glimpse(hidran_mod)
</code></pre>

<pre><code>#&gt; Observations: 82
#&gt; Variables: 4
#&gt; $ wilayah &lt;fct&gt; Jakarta Barat, Jakarta Barat, Jakarta Barat, Jakarta B...
#&gt; $ lokasi  &lt;chr&gt; &quot;Cengkareng&quot;, &quot;Cengkareng&quot;, &quot;Grogolpetamburan&quot;, &quot;Grogo...
#&gt; $ kondisi &lt;chr&gt; &quot;Baik&quot;, &quot;Rusak&quot;, &quot;Baik&quot;, &quot;Rusak&quot;, &quot;Baik&quot;, &quot;Rusak&quot;, &quot;Ba...
#&gt; $ jumlah  &lt;int&gt; 13, 1, 21, 4, 3, 3, 5, 2, 36, 7, 7, 7, 7, 7, 21, 10, 2...
</code></pre>

<h3 id="combining-data">Combining Data</h3>

<p>In merging data, there are several things that we&rsquo;ll do:</p>

<ul>
<li>Combining the <code>json</code> data we have with the <code>hydrant</code> data, where <code>NAME_2</code> in the <code>json</code> data will be paired with <code>territory</code>/<code>wilayah</code> in the <code>hydrant</code> data, and <code>NAME_3</code> with <code>location</code>/<code>lokasi</code></li>
<li>Performs the <code>complete</code> function to fill <code>kondisi</code>(<code>Baik</code>/<code>Rusak</code>) in areas not previously listed in the <code>hydrant</code> data</li>
<li>Sort the data to then fill in the <code>NA</code> values</li>
<li>Use the <code>fill</code> function from <code>tidyr</code> to fill missing values <strong>except</strong> the <code>amount</code>/<code>jumlah</code> and <code>kondisi</code> column, in a downward direction. We do this because there are conditions when we have geometric data but do not have a <code>jumlah</code> for each <code>kondisi</code>, and vice versa. By doing this, we will get complete information on each column except <code>jumlah</code>, <code>geometry</code>, and <code>kondisi</code> only</li>
<li>Fill in the value in the <code>geometry</code> column using looping function. Here the <code>lengths</code> function is used which returns whether a list has contents or not. If it is empty, it will be filled with a list above it (using the <code>list.take</code> function from the <code>rlist</code> library and taking the list to <code>[i-1]</code> or one row above)</li>
<li>Replacing the value of <code>NA</code> in <code>jumlah</code> with <code>0</code></li>
<li>Removes lines with <code>kondisi == NA</code></li>
</ul>

<pre><code class="language-r">jakarta_hidran &lt;- jakarta_json_mod %&gt;% 
  left_join(hidran_mod, by = c(&quot;NAME_2&quot; = &quot;wilayah&quot;, &quot;NAME_3&quot; = &quot;lokasi&quot;)) %&gt;% 
  complete(kondisi, NAME_3) %&gt;% 
  arrange(NAME_3, NAME_0) %&gt;% 
  tidyr::fill(-c(jumlah, kondisi), .direction = &quot;down&quot;) 

# Create a looping function to fill empty row in `geometri` column
for (i in 1:nrow(jakarta_hidran)) {
  jakarta_hidran$geometry[i] &lt;- ifelse(!lengths(jakarta_hidran$geometry[i]), 
                                    rlist::list.take(jakarta_hidran$geometry[i-1], n = 1), 
                                    jakarta_hidran$geometry[i])
}

jakarta_hidran &lt;- jakarta_hidran %&gt;% 
  mutate(jumlah = replace_na(jumlah, replace = 0)) %&gt;% 
  na.omit()

glimpse(jakarta_hidran)
</code></pre>

<pre><code>#&gt; Observations: 90
#&gt; Variables: 12
#&gt; $ kondisi  &lt;chr&gt; &quot;Baik&quot;, &quot;Rusak&quot;, &quot;Baik&quot;, &quot;Rusak&quot;, &quot;Baik&quot;, &quot;Rusak&quot;, &quot;B...
#&gt; $ NAME_3   &lt;chr&gt; &quot;Cakung&quot;, &quot;Cakung&quot;, &quot;Cempakaputih&quot;, &quot;Cempakaputih&quot;, &quot;...
#&gt; $ GID_0    &lt;fct&gt; IDN, IDN, IDN, IDN, IDN, IDN, IDN, IDN, IDN, IDN, IDN...
#&gt; $ NAME_0   &lt;fct&gt; Indonesia, Indonesia, Indonesia, Indonesia, Indonesia...
#&gt; $ GID_1    &lt;fct&gt; IDN.7_1, IDN.7_1, IDN.7_1, IDN.7_1, IDN.7_1, IDN.7_1,...
#&gt; $ NAME_1   &lt;fct&gt; Jakarta Raya, Jakarta Raya, Jakarta Raya, Jakarta Ray...
#&gt; $ GID_2    &lt;fct&gt; IDN.7.4_1, IDN.7.4_1, IDN.7.2_1, IDN.7.2_1, IDN.7.1_1...
#&gt; $ NAME_2   &lt;fct&gt; Jakarta Timur, Jakarta Timur, Jakarta Pusat, Jakarta ...
#&gt; $ GID_3    &lt;fct&gt; IDN.7.4.1_1, IDN.7.4.1_1, IDN.7.2.1_1, IDN.7.2.1_1, I...
#&gt; $ CC_3     &lt;fct&gt; 3172080, 3172080, 3173050, 3173050, 3174070, 3174070,...
#&gt; $ jumlah   &lt;dbl&gt; 51, 12, 21, 10, 13, 1, 10, 16, 57, 9, 0, 0, 16, 1, 0,...
#&gt; $ geometry &lt;MULTIPOLYGON&gt; MULTIPOLYGON (((106.9508 -6..., MULTIPOLYGON...
</code></pre>

<p>When we do a simple <code>leaflet</code> mapping using <code>jakarta_hidran</code> data, we get an error like this:</p>

<pre><code class="language-r">leaflet(jakarta_hidran) %&gt;% 
  addTiles() %&gt;% 
  addPolygons()
</code></pre>

<pre><code>#&gt; Error in polygonData.default(data): Don't know how to get path data from object of class tbl_df
</code></pre>

<p>This is because when we perform the <code>complete</code> function, our data will be converted into<code>tbl_df</code> data type, and this type is not accepted by <code>leaflet</code>.</p>

<pre><code class="language-r">class(jakarta_hidran)
</code></pre>

<pre><code>#&gt; [1] &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;
</code></pre>

<p>For that, we will change it back to <code>sf</code>.</p>

<pre><code class="language-r">jakarta_hidran_sf &lt;- jakarta_hidran %&gt;% sf::st_as_sf()

class(jakarta_hidran_sf)
</code></pre>

<pre><code>#&gt; [1] &quot;sf&quot;         &quot;tbl_df&quot;     &quot;tbl&quot;        &quot;data.frame&quot;
</code></pre>

<h2 id="showing-the-choropleth-using-leaflet">Showing the Choropleth using <code>leaflet</code></h2>

<p>In presenting data, we will first put our data into leaflet. Then, the appropriate coloring for <em>choropleth</em> will be formed. Palette is determined from red to blue (please see <em>cheatsheet</em> that has been provided). In addition, a popup is also made for each place.</p>

<pre><code class="language-r"># leaflet
m &lt;- leaflet(jakarta_hidran_sf)

# Coloring
temp_baik &lt;- jakarta_hidran_sf %&gt;% 
  filter(kondisi == &quot;Baik&quot;) %&gt;% 
  dplyr::select(GID_3, NAME_3, jumlah)
temp_rusak &lt;- jakarta_hidran_sf %&gt;% 
  filter(kondisi == &quot;Rusak&quot;) %&gt;% 
  dplyr::select(GID_3, NAME_3, jumlah) 

# -1 &lt;= x &lt;= 1
col_formula &lt;- (temp_baik$jumlah - temp_rusak$jumlah)/(temp_baik$jumlah + temp_rusak$jumlah) 
col &lt;- col_formula %&gt;% replace(is.nan(.), 0)

bins &lt;- c(-1, fivenum(col))

pal &lt;- colorBin(&quot;RdYlBu&quot;, domain = col, bins = bins)

# Popup
popup.cont  &lt;- paste(&quot;&lt;h2&gt;&lt;b&gt;&quot;, jakarta_hidran_sf$NAME_3, &quot;&lt;/b&gt;&lt;/h2&gt;&quot;,
   &quot;&lt;h4&gt;&lt;b&gt; Baik: &quot;, temp_baik$jumlah, &quot;&lt;/h4&gt;&lt;/b&gt;&quot;,
   &quot;&lt;h4&gt;&lt;b&gt; Rusak: &quot;, temp_rusak$jumlah, &quot;&lt;/h4&gt;&lt;/b&gt;&quot;
)
</code></pre>

<p>And finally, we will form a map with <em>tiles</em> provided by <code>CartoDB</code> using the <code>addProviderTiles</code> function. Then we set polygons and legends on the map. We also change the name of each element in the legend to make it more sensible.</p>

<pre><code class="language-r">map1 &lt;- m %&gt;% 
  addProviderTiles(providers$CartoDB.DarkMatter) %&gt;% 
  addPolygons(fillColor = ~pal(col),
              weight = 1,
              opacity = 1,
              color = &quot;black&quot;,
              dashArray = &quot;3&quot;,
              fillOpacity = 0.5,
              label = paste0(&quot;Kecamatan: &quot;, jakarta_hidran_sf$NAME_3),
              popup = popup.cont) %&gt;%
  addLegend(&quot;bottomright&quot;, 
            pal = pal,
            values = ~col,
            title = &quot;Hydrant Condition&quot;,
            labFormat = labelFormat(digits = 2),
            opacity = 1)

map1
</code></pre>

<iframe seamless src="/img/map1.html" width="100%" height="500"></iframe>

<p>For the record, we can also arrange each part of the <em>legend</em> by adjusting the colors one by one (taken by using <code>inspect element</code>) and we can label it from there. If it is not done like this, then the text in the legend cannot be changed and is still shown in numeric form even though it has been given the <code>labels</code> parameter. Also, be aware that in order for the <code>colors</code> parameter to work, the <code>pal</code> parameter in <code>addLegend</code> must be removed.</p>

<pre><code class="language-r">map2 &lt;- m %&gt;% 
  addProviderTiles(providers$CartoDB.DarkMatter) %&gt;% 
  addPolygons(fillColor = ~pal(col),
              weight = 1,
              opacity = 1,
              color = &quot;black&quot;,
              dashArray = &quot;3&quot;,
              fillOpacity = 0.5,
              label = paste0(&quot;Kecamatan: &quot;, jakarta_hidran_sf$NAME_3),
              popup = popup.cont) %&gt;%
  addLegend(&quot;bottomright&quot;, 
            values = ~col,
            colors =c(&quot;#D7191C&quot;, &quot;#FDAE61&quot;, &quot;#FFFFBF&quot;, &quot;#ABD9E9&quot;, &quot;#2C7BB6&quot;), # Taken from `inspect element` with condition parameter `pal` exists
            labels= c(&quot;Terrible&quot;, &quot;Bad&quot;, &quot;Decent/No Hydrant&quot;, &quot;Good&quot;, &quot;Great&quot;),
            title = &quot;Hydrant Condition&quot;,
            labFormat = labelFormat(digits = 2),
            opacity = 1)
map2
</code></pre>

<iframe seamless src="/img/map2.html" width="100%" height="500"></iframe>

<h2 id="additional-information">Additional Information</h2>
<div class="footnotes">

<hr />

<ol>
<li id="fn:note-1"><a href="https://www.data-to-viz.com/">https://www.data-to-viz.com/</a> - examples of using maps for data
 <a class="footnote-return" href="#fnref:note-1"><sup>[return]</sup></a></li>
<li id="fn:note-2"><a href="http://webhelp.esri.com/arcgisdesktop/9.3/index.cfm?TopicName=Shapefile_file_extensions">http://webhelp.esri.com/arcgisdesktop/9.3/index.cfm?TopicName=Shapefile_file_extensions</a> - Information about extensions from shapefiles
 <a class="footnote-return" href="#fnref:note-2"><sup>[return]</sup></a></li>
<li id="fn:note-3">If the data we read has a meeting point, we can simplify it before we extract them to avoid things that are not desirable. This can be done by <code>simplify</code> at the top right. To see information for each point, please check the <code>?</code> Section.
 <a class="footnote-return" href="#fnref:note-3"><sup>[return]</sup></a></li>
<li id="fn:note-4"><a href="https://stackoverflow.com/questions/14740705/difference-between-geojson-and-topojson">https://stackoverflow.com/questions/14740705/difference-between-geojson-and-topojson</a> - Differences between GeoJSON and TopoJSON
 <a class="footnote-return" href="#fnref:note-4"><sup>[return]</sup></a></li>
<li id="fn:note-5"><a href="http://strimas.com/r/tidy-sf/">http://strimas.com/r/tidy-sf/</a> - <code>sf</code> replaces <code>sp</code> to handle spatial objects, and is formed to complement <code>tidyverse</code>
 <a class="footnote-return" href="#fnref:note-5"><sup>[return]</sup></a></li>
</ol>
</div>

  </div>

  <footer>
    <ul class="stats">
  <li class="categories">
    <ul>
        
            
            
                <i class="fa fa-folder"></i>
                
                
                <li><a class="article-category-link" href="/categories/r">R</a></li>
                
            
        
    </ul>
  </li>
  <li class="tags">
    <ul>
        
            
            
                <i class="fa fa-tags"></i>
                
                
                <li><a class="article-category-link" href="/tags/geocoding">Geocoding</a></li>
                
                
                <li><a class="article-category-link" href="/tags/mapshaper">Mapshaper</a></li>
                
                
                <li><a class="article-category-link" href="/tags/leaflet">Leaflet</a></li>
                
                
                <li><a class="article-category-link" href="/tags/map">Map</a></li>
                
                
                <li><a class="article-category-link" href="/tags/data-visualization">Data Visualization</a></li>
                
            
        
    </ul>
  </li>
</ul>

  </footer>

</article>

    <article class="post">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-algotech-netlify-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </article>


<ul class="actions pagination">
    
        <li><a href="/blog/self-organizing-maps/"
                class="button big previous">Self-Organizing Maps</a></li>
    

    
        <li><a href="/blog/tidymodels/"
                class="button big next">Introduction to tidymodels</a></li>
    
</ul>


    </div>
    
<section id="sidebar">

  
  <section id="intro">
    
    
      
        <a href='/'><img src="/img/main/logo.png" class="intro-circle" width="30%" alt="Hugo Future Imperfect" /></a>
      
    
    
      <header>
        <h2>Algoritma Technical Blog</h2>
        <p>We're a group of people who teach data science to individuals, trains companies and their employees to better profit from data. We care about the development of data science and a sense of community that connects our alumni and team with one another. To learn more about our approach to data science problems, feel free to hop over to our blog.</p>
      </header>
    
    
      <ul class="icons">
        
        
  <li><a href="//github.com/teamalgoritma" target="_blank" title="GitHub" class="fa fa-github"></a></li>



























  <li><a href="//linkedin.com/company/teamalgoritma" target="_blank" title="LinkedIn Company" class="fa fa-linkedin"></a></li>









  <li><a href="//facebook.com/teamalgoritma" target="_blank" title="Facebook" class="fa fa-facebook"></a></li>





















  <li><a href="//instagram.com/teamalgoritma" target="_blank" title="Instagram" class="fa fa-instagram"></a></li>





  <li><a href="//twitter.com/teamalgoritma" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




















      </ul>
    
  </section>



  
  
  

  
  

  
  <section id="footer">
    <p class="copyright">
      
        &copy; 2019
        
          Algoritma Technical Blog
        
      .
      Powered by <a href="//gohugo.io" target="_blank">Hugo</a>
    </p>
  </section>
</section>

    </div>
    <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
    

    
      
    

    
      
      
      
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>
        
        
        
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/css.min.js"></script>
        <script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>
      
    
    
    
      <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js"></script>
      <script src="/js/util.js"></script>
      <script src="/js/main.js"></script>
      <script src="/js/backToTop.js"></script>
    

    
      
        
      
        
          <script src="/js/bootstrap.min.js"></script>
        
      
    

    
    <script>hljs.initHighlightingOnLoad();</script>
      <script src="//yihui.name/js/math-code.js"></script>
<script async
src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


  </body>
</html>

