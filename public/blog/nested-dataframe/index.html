<!DOCTYPE HTML>

<html>
    <head>
        <script type="application/ld+json">
    {
        "@context" : "http://schema.org",
        "@type" : "BlogPosting",
        "mainEntityOfPage": {
             "@type": "WebPage",
             "@id": "\/"
        },
        "articleSection" : "blog",
        "name" : "Nested Dataframe",
        "headline" : "Nested Dataframe",
        "description" : "1. Setup\rLibraries and Setup\rWe’ll set-up caching for this notebook given how computationally expensive some of the code we will write can get.\nYou will need to use install.packages() to install any packages that are not already downloaded onto your machine. You then load the package into your workspace using the library() function:\nlibrary(tidyverse)\rlibrary(caret)\r\r\r2. Nested Dataframe\rYou’ll learn how to use purrr, caret and dplyr to quickly create some of dataset \x2b model combinations, store data \x26amp; model objects neatly in one tibble, and post process programatically.",
        "inLanguage" : "en",
        "author" : "",
        "creator" : "",
        "publisher": "",
        "accountablePerson" : "",
        "copyrightHolder" : "",
        "copyrightYear" : "2019",
        "datePublished": "2019-01-10 00:00:00 \x2b0000 UTC",
        "dateModified" : "2019-01-10 00:00:00 \x2b0000 UTC",
        "url" : "\/blog\/nested-dataframe\/",
        "wordCount" : "2107",
        "keywords" : [ "Data Manipulation","tidyverse","Capstone Ml","Blog" ]
    }
    </script>
        
            
                <title>Nested Dataframe</title>
            
        

        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="generator" content="Hugo 0.59.1" />
        


        
            <meta name="author" content="David">
        
        
            
                <meta name="description" content="HTML5 UP theme, Future Imperfect with some extra goodies, ported by Julio Pescador. Powered by Hugo">
            
        

        <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Nested Dataframe"/>
<meta name="twitter:description" content="1. SetupLibraries and SetupWe’ll set-up caching for this notebook given how computationally expensive some of the code we will write can get.
You will need to use install.packages() to install any packages that are not already downloaded onto your machine. You then load the package into your workspace using the library() function:
library(tidyverse)library(caret)2. Nested DataframeYou’ll learn how to use purrr, caret and dplyr to quickly create some of dataset &#43; model combinations, store data &amp; model objects neatly in one tibble, and post process programatically."/>
<meta name="twitter:site" content="@teamalgoritma"/>

        <meta property="og:title" content="Nested Dataframe" />
<meta property="og:description" content="1. SetupLibraries and SetupWe’ll set-up caching for this notebook given how computationally expensive some of the code we will write can get.
You will need to use install.packages() to install any packages that are not already downloaded onto your machine. You then load the package into your workspace using the library() function:
library(tidyverse)library(caret)2. Nested DataframeYou’ll learn how to use purrr, caret and dplyr to quickly create some of dataset &#43; model combinations, store data &amp; model objects neatly in one tibble, and post process programatically." />
<meta property="og:type" content="article" />
<meta property="og:url" content="/blog/nested-dataframe/" />
<meta property="article:published_time" content="2019-01-10T00:00:00+00:00" />
<meta property="article:modified_time" content="2019-01-10T00:00:00+00:00" />

        <meta property="og:image" content="//images/logo.png">
        <meta property="og:image:type" content="image/png">
        <meta property="og:image:width" content="512">
        <meta property="og:image:height" content="512">
        <meta itemprop="name" content="Nested Dataframe">
<meta itemprop="description" content="1. SetupLibraries and SetupWe’ll set-up caching for this notebook given how computationally expensive some of the code we will write can get.
You will need to use install.packages() to install any packages that are not already downloaded onto your machine. You then load the package into your workspace using the library() function:
library(tidyverse)library(caret)2. Nested DataframeYou’ll learn how to use purrr, caret and dplyr to quickly create some of dataset &#43; model combinations, store data &amp; model objects neatly in one tibble, and post process programatically.">


<meta itemprop="datePublished" content="2019-01-10T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2019-01-10T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2107">



<meta itemprop="keywords" content="Data Manipulation,tidyverse,Capstone Ml," />

        

        
            
        

        
        
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
            <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway:400,800,900|Source+Sans+Pro:400,700">
            <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.css">
            <link rel="stylesheet" href="/css/main.css">
            <link rel="stylesheet" href="/css/add-on.css">
            <link rel="stylesheet" href="/css/academicons.min.css">
        

        
            
                
            
                
                    <link rel="stylesheet" href="/css/monokai-sublime.css">
                
            
        


  
    
      <link rel="stylesheet" href="/css/monokai-sublime.css" rel="stylesheet" id="theme-stylesheet">
      <script src="/js/highlight.pack.js"></script>
      <script>hljs.initHighlightingOnLoad();</script>
  


      





    </head>
    <body>

      
      <div id="wrapper">

    
    
<header id="header">
    
      <h1><a href="/">blog</a></h1>
    

    <nav class="links">
        <ul>
            
                <li>
                    <a href="/">
                            <i class="fa fa-home">&nbsp;</i>Home
                    </a>
                </li>
            
                <li>
                    <a href="/about/">
                            <i class="fa fa-id-card-o">&nbsp;</i>About
                    </a>
                </li>
            
                <li>
                    <a href="/tags/machine-learning/">
                            <i class="fa fa-cog">&nbsp;</i>Machine Learning
                    </a>
                </li>
            
                <li>
                    <a href="/tags/data-visualization/">
                            <i class="fa fa-area-chart">&nbsp;</i>Data Visualization
                    </a>
                </li>
            
        </ul>
    </nav>
    <nav class="main">
        <ul>
            
            <li id="share-nav" class="share-menu" style="display:none;">
                <a class="fa-share-alt" href="#share-menu">Share</a>
            </li>
            
            <li class="search">
                <a class="fa-search" href="#search">Search</a>
                <form id="search" method="get" action="//google.com/search">
                    <input type="text" name="q" placeholder="Search" />
                    <input type="hidden" name="as_sitesearch" value="/">
                </form>
            </li>
            <li class="menu">
                <a class="fa-bars" href="#menu">Menu</a>
            </li>
        </ul>
    </nav>
</header>


<section id="menu">

    
        <section>
            <form class="search" method="get" action="//google.com/search">
                <input type="text" name="q" placeholder="Search" />
                <input type="hidden" name="as_sitesearch" value="/">
            </form>
        </section>

    
        <section>
            <ul class="links">
                
                    <li>
                        <a href="/">
                            <h3>
                                <i class="fa fa-home">&nbsp;</i>Home
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/about/">
                            <h3>
                                <i class="fa fa-id-card-o">&nbsp;</i>About
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags/machine-learning/">
                            <h3>
                                <i class="fa fa-cog">&nbsp;</i>Machine Learning
                            </h3>
                        </a>
                    </li>
                
                    <li>
                        <a href="/tags/data-visualization/">
                            <h3>
                                <i class="fa fa-area-chart">&nbsp;</i>Data Visualization
                            </h3>
                        </a>
                    </li>
                
            </ul>
        </section>

    
        <section class="recent-posts">
            <div class="mini-posts">
                <header>
                    <h3>Recent Posts</h3>
                </header>
                

                
                    
                

                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/biocode/">Bioinformatics: Decoding Nature&#39;s Code of Life</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-11-27'>
                                    November 27, 2019</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/poisson-regression-and-negative-binomial-regression/">Poisson Regression and Negative Binomial Regression</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-10-22'>
                                    October 22, 2019</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/tidymodels/">Introduction to tidymodels</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-10-06'>
                                    October 6, 2019</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/creating-choropleth-with-mapshaper-and-r/">Creating Choropleth with Mapshaper and R</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-08-18'>
                                    August 18, 2019</time>
                            </header>
                            

                        </article>
                
                        <article class="mini-post">
                            <header>
                                <h3><a href="/blog/self-organizing-maps/">Self-Organizing Maps</a></h3>
                                
                                <time class="published" datetime=
                                    '2019-04-26'>
                                    April 26, 2019</time>
                            </header>
                            

                        </article>
                

                
                    <a href=
                        
                            /blog/
                        
                        class="button">View more posts</a>
                
            </div>
        </section>

    
        
</section>

    <section id="share-menu">
    <section id="social-share-nav">
        <ul class="links">
            <header>
                <h3>Share this post <i class="fa fa-smile-o"></i></h3>
            </header>
            



<li>
  <a href="//twitter.com/share?url=%2fblog%2fnested-dataframe%2f&amp;text=Nested%20Dataframe&amp;via=teamalgoritma" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>








<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=%2fblog%2fnested-dataframe%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
    </a>
</li>







<li>
  <a href="//www.linkedin.com/shareArticle?url=%2fblog%2fnested-dataframe%2f&amp;title=Nested%20Dataframe" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>











        </ul>
    </section>
</section>

    
    <div id="main">
        
        
        <article class="post">
  <header>
    <div class="title">
        
            <h2><a href="/blog/nested-dataframe/">Nested Dataframe</a></h2>
        
        
    </div>
    <div class="meta">
        

        <time class="published"
            datetime='2019-01-10'>
            January 10, 2019</time>
        <span class="author">David</span>
        
            <p>10 minute read</p>
        
        
    </div>
</header>


  
    <section id="social-share">
      <ul class="icons">
        



<li>
  <a href="//twitter.com/share?url=%2fblog%2fnested-dataframe%2f&amp;text=Nested%20Dataframe&amp;via=teamalgoritma" target="_blank" class="share-btn twitter">
    <i class="fa fa-twitter"></i>
    <p>Twitter</p>
    </a>
</li>








<li>
  <a href="//www.facebook.com/sharer/sharer.php?u=%2fblog%2fnested-dataframe%2f" target="_blank" class="share-btn facebook">
    <i class="fa fa-facebook"></i>
    <p>Facebook</p>
    </a>
</li>







<li>
  <a href="//www.linkedin.com/shareArticle?url=%2fblog%2fnested-dataframe%2f&amp;title=Nested%20Dataframe" target="_blank" class="share-btn linkedin">
      <i class="fa fa-linkedin"></i>
      <p>LinkedIn</p>
    </a>
</li>











      </ul>
    </section>
  

  
    

    
        
        







  
  
    
  


        
        
        

        <a href="/blog/nested-dataframe/" class="image featured">
            <img src="/img/2019/01/Nested.png" alt="">
        </a>
    


  <div id="content">
    


<div id="setup" class="section level1">
<h1>1. Setup</h1>
<div id="libraries-and-setup" class="section level2">
<h2>Libraries and Setup</h2>
<p>We’ll set-up caching for this notebook given how computationally expensive some of the code we will write can get.</p>
<p>You will need to use <code>install.packages()</code> to install any packages that are not already downloaded onto your machine. You then load the package into your workspace using the <code>library()</code> function:</p>
<pre class="r"><code>library(tidyverse)
library(caret)</code></pre>
</div>
</div>
<div id="nested-dataframe" class="section level1">
<h1>2. Nested Dataframe</h1>
<p>You’ll learn how to use <code>purrr</code>, <code>caret</code> and <code>dplyr</code> to quickly create some of dataset + model combinations, store data &amp; model objects neatly in one tibble, and post process programatically. These tools enable succinct functional programming in which a lot gets done with just a few lines of code. The data to be used is loan.csv which can be downloaded here <a href="https://drive.google.com/file/d/1cxHMOPZwKDZ-mUI-fUyRJdlr_2q_Pdh6/view?usp=sharing">link here</a>. In this article we will predict the <code>default</code> variable which has a yes or no value.</p>
<pre class="r"><code>loan &lt;- read.csv(&quot;data_input/loan.csv&quot;)
glimpse(loan)</code></pre>
<pre><code>#&gt; Observations: 1,000
#&gt; Variables: 17
#&gt; $ checking_balance     &lt;fct&gt; &lt; 0 DM, 1 - 200 DM, unknown, &lt; 0 DM, &lt; 0 ...
#&gt; $ months_loan_duration &lt;int&gt; 6, 48, 12, 42, 24, 36, 24, 36, 12, 30, 12...
#&gt; $ credit_history       &lt;fct&gt; critical, good, critical, good, poor, goo...
#&gt; $ purpose              &lt;fct&gt; furniture/appliances, furniture/appliance...
#&gt; $ amount               &lt;int&gt; 1169, 5951, 2096, 7882, 4870, 9055, 2835,...
#&gt; $ savings_balance      &lt;fct&gt; unknown, &lt; 100 DM, &lt; 100 DM, &lt; 100 DM, &lt; ...
#&gt; $ employment_duration  &lt;fct&gt; &gt; 7 years, 1 - 4 years, 4 - 7 years, 4 - ...
#&gt; $ percent_of_income    &lt;int&gt; 4, 2, 2, 2, 3, 2, 3, 2, 2, 4, 3, 3, 1, 4,...
#&gt; $ years_at_residence   &lt;int&gt; 4, 2, 3, 4, 4, 4, 4, 2, 4, 2, 1, 4, 1, 4,...
#&gt; $ age                  &lt;int&gt; 67, 22, 49, 45, 53, 35, 53, 35, 61, 28, 2...
#&gt; $ other_credit         &lt;fct&gt; none, none, none, none, none, none, none,...
#&gt; $ housing              &lt;fct&gt; own, own, own, other, other, other, own, ...
#&gt; $ existing_loans_count &lt;int&gt; 2, 1, 1, 1, 2, 1, 1, 1, 1, 2, 1, 1, 1, 2,...
#&gt; $ job                  &lt;fct&gt; skilled, skilled, unskilled, skilled, ski...
#&gt; $ dependents           &lt;int&gt; 1, 1, 2, 2, 2, 2, 1, 1, 1, 1, 1, 1, 1, 1,...
#&gt; $ phone                &lt;fct&gt; yes, no, no, no, no, yes, no, yes, no, no...
#&gt; $ default              &lt;fct&gt; no, yes, no, no, yes, no, no, no, no, yes...</code></pre>
<pre class="r"><code>loan &lt;- loan %&gt;%
  head(-10)

test &lt;- loan %&gt;% 
  tail(10) %&gt;% 
  select(-default)</code></pre>
<p>The loan data will be divided into test data and loan data. Test data will be used when testing the model that has been made, while the data loan will be used to model the classification.</p>
<div id="single-data-frame-x-multiple-model" class="section level2">
<h2>2.1 Single Data Frame x Multiple Model</h2>
<p>Before creating a nested dataframe, we must prepare a model that will be used first. The model to be used must be used as a function to make it easier when used in the <code>map ()</code> function that comes from the <code>purrr</code> package. besides that we can set the parameters that will be used in the function. In the chunk below 2 models are created, namely the decision tree and random forest using the <code>caret</code> package.</p>
<pre class="r"><code>#create Random forest function
RandomForestModel &lt;- function(X, Y){
    ctrl &lt;- trainControl(
        method = &quot;cv&quot;,
        number = 3
    )
    train(
        x = X,
        y = Y,
        trContrl = ctrl,
        method = &#39;rf&#39;
    )
}

#create decision tree function
RpartModel &lt;- function(X, Y) {
    ctrl &lt;- trainControl(
        method = &quot;repeatedcv&quot;,
        number = 5
    )
    train(
        x = X,
        y = Y,
        method = &#39;rpart2&#39;,
        trControl = ctrl,
        tuneGrid = data.frame(maxdepth=c(2,3,4,5)),
        preProc = c(&#39;center&#39;, &#39;scale&#39;)
    )
}</code></pre>
<p>After making a model in the form of a function, then making the model into a dataframe.</p>
<pre class="r"><code>model_list &lt;- list(rpart = RpartModel,
                   rforest = RandomForestModel) %&gt;%
    enframe(name = &#39;modelName&#39;,value = &#39;model&#39;)
model_list</code></pre>
<pre><code>#&gt; # A tibble: 2 x 2
#&gt;   modelName model 
#&gt;   &lt;chr&gt;     &lt;list&gt;
#&gt; 1 rpart     &lt;fn&gt;  
#&gt; 2 rforest   &lt;fn&gt;</code></pre>
<p><code>model_list</code> produces 2 columns, namely <code>modelName</code>, and <code>model</code>. <code>ModelName</code> is the name of the model, and the <code>model</code> contains the functions of the model.
Next the dataframe to be used replicates as many models as you want to use. The loan dataset will be replicates as much as the model used by <code>rep ()</code> function.</p>
<pre class="r"><code>nmodel &lt;- length(model_list) #get length of model_list

nested.loan &lt;- list(loan) %&gt;% 
  rep(nmodel) %&gt;% 
  enframe(name = &quot;Id&quot;, value = &quot;rawdata&quot;)
nested.loan</code></pre>
<pre><code>#&gt; # A tibble: 2 x 2
#&gt;      Id rawdata             
#&gt;   &lt;int&gt; &lt;list&gt;              
#&gt; 1     1 &lt;df[,17] [990 x 17]&gt;
#&gt; 2     2 &lt;df[,17] [990 x 17]&gt;</code></pre>
<p><code>nested.loan</code> has 2 columns, namely <code>Id</code> and <code>rawdata</code> which contain the loan dataframe. Then rawdata will be separated into train.y which contains the <code>default</code> variable and train.x contains the others.</p>
<pre class="r"><code>nested.loan &lt;- nested.loan %&gt;% 
  mutate(train.x = map(rawdata, ~select(.x, -default)),
         train.y = map(rawdata, ~.x$default))
nested.loan</code></pre>
<pre><code>#&gt; # A tibble: 2 x 4
#&gt;      Id rawdata              train.x              train.y    
#&gt;   &lt;int&gt; &lt;list&gt;               &lt;list&gt;               &lt;list&gt;     
#&gt; 1     1 &lt;df[,17] [990 x 17]&gt; &lt;df[,16] [990 x 16]&gt; &lt;fct [990]&gt;
#&gt; 2     2 &lt;df[,17] [990 x 17]&gt; &lt;df[,16] [990 x 16]&gt; &lt;fct [990]&gt;</code></pre>
<p>The next step is to join <code>nested.loan</code> with<code>model_list</code> using <code>bind_cols ()</code></p>
<pre class="r"><code>nested.loan &lt;- nested.loan %&gt;% 
  bind_cols(model_list)
nested.loan</code></pre>
<pre><code>#&gt; # A tibble: 2 x 6
#&gt;      Id rawdata             train.x             train.y     modelName model
#&gt;   &lt;int&gt; &lt;list&gt;              &lt;list&gt;              &lt;list&gt;      &lt;chr&gt;     &lt;lis&gt;
#&gt; 1     1 &lt;df[,17] [990 x 17~ &lt;df[,16] [990 x 16~ &lt;fct [990]&gt; rpart     &lt;fn&gt; 
#&gt; 2     2 &lt;df[,17] [990 x 17~ &lt;df[,16] [990 x 16~ &lt;fct [990]&gt; rforest   &lt;fn&gt;</code></pre>
<p>The model we have created can be used with the function <code>invoke_map ()</code> which functions to combine functions and lists as parameters.</p>
<pre class="r"><code>nested.loan &lt;- nested.loan %&gt;% 
  mutate(parm = map2(train.x, train.y, ~list(.x, .y)),
         model = invoke_map(model,parm))
nested.loan</code></pre>
<pre><code>#&gt; # A tibble: 2 x 7
#&gt;      Id rawdata         train.x         train.y    modelName model  parm   
#&gt;   &lt;int&gt; &lt;list&gt;          &lt;list&gt;          &lt;list&gt;     &lt;chr&gt;     &lt;list&gt; &lt;list&gt; 
#&gt; 1     1 &lt;df[,17] [990 ~ &lt;df[,16] [990 ~ &lt;fct [990~ rpart     &lt;trai~ &lt;list ~
#&gt; 2     2 &lt;df[,17] [990 ~ &lt;df[,16] [990 ~ &lt;fct [990~ rforest   &lt;trai~ &lt;list ~</code></pre>
<p>To see how well the model has been made, it can be seen from the Accuracy of each model.</p>
<pre class="r"><code>nested.loan &lt;- nested.loan %&gt;% 
  mutate(Accuracy = map_dbl(model, ~max(.x$results$Accuracy))) %&gt;% 
  arrange(desc(Accuracy))
nested.loan</code></pre>
<pre><code>#&gt; # A tibble: 2 x 8
#&gt;      Id rawdata      train.x      train.y   modelName model parm   Accuracy
#&gt;   &lt;int&gt; &lt;list&gt;       &lt;list&gt;       &lt;list&gt;    &lt;chr&gt;     &lt;lis&gt; &lt;list&gt;    &lt;dbl&gt;
#&gt; 1     2 &lt;df[,17] [9~ &lt;df[,16] [9~ &lt;fct [99~ rforest   &lt;tra~ &lt;list~    0.759
#&gt; 2     1 &lt;df[,17] [9~ &lt;df[,16] [9~ &lt;fct [99~ rpart     &lt;tra~ &lt;list~    0.738</code></pre>
<p>From the above results it can be seen that the random forest model produces an accuracy of 0.75 and the decission tree is 0.74. Next, we will do predict to the test data that has been made using an existing model. the data test must replicate as many models as used and then join the <code>nested.loan</code> data using <code>left_join()</code></p>
<pre class="r"><code>nested.loan &lt;- test %&gt;% 
  list() %&gt;% 
  rep(nrow(nested.loan)) %&gt;% 
  enframe(name = &quot;Id&quot;,value = &quot;test.x&quot;) %&gt;% 
  left_join(nested.loan, by = &quot;Id&quot;)
nested.loan</code></pre>
<pre><code>#&gt; # A tibble: 2 x 9
#&gt;      Id test.x   rawdata   train.x   train.y modelName model parm  Accuracy
#&gt;   &lt;int&gt; &lt;list&gt;   &lt;list&gt;    &lt;list&gt;    &lt;list&gt;  &lt;chr&gt;     &lt;lis&gt; &lt;lis&gt;    &lt;dbl&gt;
#&gt; 1     1 &lt;df[,16~ &lt;df[,17]~ &lt;df[,16]~ &lt;fct [~ rpart     &lt;tra~ &lt;lis~    0.738
#&gt; 2     2 &lt;df[,16~ &lt;df[,17]~ &lt;df[,16]~ &lt;fct [~ rforest   &lt;tra~ &lt;lis~    0.759</code></pre>
<p>Now we create a <code>pred</code> variable that contains results from predict</p>
<pre class="r"><code>nested.loan &lt;- nested.loan %&gt;% 
  mutate(pred = map2(model, test.x, ~predict(.x, .y))) %&gt;% 
  select(Id,modelName,Accuracy,pred)
glimpse(nested.loan$pred)</code></pre>
<pre><code>#&gt; List of 2
#&gt;  $ : Factor w/ 2 levels &quot;no&quot;,&quot;yes&quot;: 2 1 1 2 1 1 1 1 2 2
#&gt;  $ : Factor w/ 2 levels &quot;no&quot;,&quot;yes&quot;: 2 2 1 2 1 1 1 1 1 1</code></pre>
</div>
<div id="multiple-data-frame-x-single-model" class="section level2">
<h2>2.2 Multiple Data Frame x Single Model</h2>
<p>Now we will split loan data by <code>checking_balance</code> variable which has 4 levels namely <code>&lt; 0 DM</code>, <code>&gt; 200 DM</code>, <code>1 - 200 DM</code>, and <code>unknown</code></p>
<pre class="r"><code>nested.split &lt;- loan %&gt;%
  group_by(checking_balance) %&gt;% 
  nest(.key = &quot;rawdata&quot;) %&gt;% 
  mutate(train.x = map(rawdata, ~select(.x, -default)),
         train.y = map(rawdata, ~.x$default))
nested.split</code></pre>
<pre><code>#&gt; # A tibble: 4 x 4
#&gt;   checking_balance rawdata             train.x             train.y    
#&gt;   &lt;fct&gt;            &lt;list&gt;              &lt;list&gt;              &lt;list&gt;     
#&gt; 1 &lt; 0 DM           &lt;tibble [270 x 16]&gt; &lt;tibble [270 x 15]&gt; &lt;fct [270]&gt;
#&gt; 2 1 - 200 DM       &lt;tibble [268 x 16]&gt; &lt;tibble [268 x 15]&gt; &lt;fct [268]&gt;
#&gt; 3 unknown          &lt;tibble [389 x 16]&gt; &lt;tibble [389 x 15]&gt; &lt;fct [389]&gt;
#&gt; 4 &gt; 200 DM         &lt;tibble [63 x 16]&gt;  &lt;tibble [63 x 15]&gt;  &lt;fct [63]&gt;</code></pre>
<p>The model that will be used is random forest</p>
<pre class="r"><code>nested.rf &lt;- nested.split %&gt;% 
  mutate(param = map2(train.x, train.y, ~list(.x, .y)),
         model = invoke_map(RandomForestModel,param))
nested.rf</code></pre>
<pre><code>#&gt; # A tibble: 4 x 6
#&gt;   checking_balance rawdata         train.x        train.y   param    model 
#&gt;   &lt;fct&gt;            &lt;list&gt;          &lt;list&gt;         &lt;list&gt;    &lt;list&gt;   &lt;list&gt;
#&gt; 1 &lt; 0 DM           &lt;tibble [270 x~ &lt;tibble [270 ~ &lt;fct [27~ &lt;list [~ &lt;trai~
#&gt; 2 1 - 200 DM       &lt;tibble [268 x~ &lt;tibble [268 ~ &lt;fct [26~ &lt;list [~ &lt;trai~
#&gt; 3 unknown          &lt;tibble [389 x~ &lt;tibble [389 ~ &lt;fct [38~ &lt;list [~ &lt;trai~
#&gt; 4 &gt; 200 DM         &lt;tibble [63 x ~ &lt;tibble [63 x~ &lt;fct [63~ &lt;list [~ &lt;trai~</code></pre>
<p>To see how well the model is made, we can see the accuracy obtained from the model we made.</p>
<pre class="r"><code>nested.rf &lt;- nested.rf %&gt;% 
  mutate(Accuracy = map_dbl(model, ~max(.x$results$Accuracy)))
nested.rf</code></pre>
<pre><code>#&gt; # A tibble: 4 x 7
#&gt;   checking_balance rawdata      train.x      train.y  param  model Accuracy
#&gt;   &lt;fct&gt;            &lt;list&gt;       &lt;list&gt;       &lt;list&gt;   &lt;list&gt; &lt;lis&gt;    &lt;dbl&gt;
#&gt; 1 &lt; 0 DM           &lt;tibble [27~ &lt;tibble [27~ &lt;fct [2~ &lt;list~ &lt;tra~    0.645
#&gt; 2 1 - 200 DM       &lt;tibble [26~ &lt;tibble [26~ &lt;fct [2~ &lt;list~ &lt;tra~    0.662
#&gt; 3 unknown          &lt;tibble [38~ &lt;tibble [38~ &lt;fct [3~ &lt;list~ &lt;tra~    0.882
#&gt; 4 &gt; 200 DM         &lt;tibble [63~ &lt;tibble [63~ &lt;fct [6~ &lt;list~ &lt;tra~    0.773</code></pre>
</div>
<div id="multiple-data-frame-x-multiple-model" class="section level2">
<h2>2.3 Multiple Data Frame x Multiple Model</h2>
<p>To run multi models against multi data, we must repeat data as much as the model that will be used. <code>nested.split</code> is a data loan that is divided based on the<code>checking_balance</code> variable which contains 4 levels while the model used is 2, namely random forest and decision tree, the amount of data is 8 (4 X 2).</p>
<pre class="r"><code>#replicates nested.split as much the model will be used
nested.multi &lt;- nested.split %&gt;% 
  list() %&gt;%
  rep(nmodel) %&gt;%
  bind_rows()

#replicates model_list as much the data frame
model.multi &lt;- model_list %&gt;% 
  list() %&gt;% 
  rep(nrow(nested.split)) %&gt;% 
  bind_rows() %&gt;% 
  arrange(modelName)

#join nested.multi and model.multi
nested.multi &lt;- nested.multi %&gt;% 
  bind_cols(model.multi)
nested.multi</code></pre>
<pre><code>#&gt; # A tibble: 8 x 6
#&gt;   checking_balance rawdata         train.x        train.y   modelName model
#&gt;   &lt;fct&gt;            &lt;list&gt;          &lt;list&gt;         &lt;list&gt;    &lt;chr&gt;     &lt;lis&gt;
#&gt; 1 &lt; 0 DM           &lt;tibble [270 x~ &lt;tibble [270 ~ &lt;fct [27~ rforest   &lt;fn&gt; 
#&gt; 2 1 - 200 DM       &lt;tibble [268 x~ &lt;tibble [268 ~ &lt;fct [26~ rforest   &lt;fn&gt; 
#&gt; 3 unknown          &lt;tibble [389 x~ &lt;tibble [389 ~ &lt;fct [38~ rforest   &lt;fn&gt; 
#&gt; 4 &gt; 200 DM         &lt;tibble [63 x ~ &lt;tibble [63 x~ &lt;fct [63~ rforest   &lt;fn&gt; 
#&gt; 5 &lt; 0 DM           &lt;tibble [270 x~ &lt;tibble [270 ~ &lt;fct [27~ rpart     &lt;fn&gt; 
#&gt; 6 1 - 200 DM       &lt;tibble [268 x~ &lt;tibble [268 ~ &lt;fct [26~ rpart     &lt;fn&gt; 
#&gt; 7 unknown          &lt;tibble [389 x~ &lt;tibble [389 ~ &lt;fct [38~ rpart     &lt;fn&gt; 
#&gt; 8 &gt; 200 DM         &lt;tibble [63 x ~ &lt;tibble [63 x~ &lt;fct [63~ rpart     &lt;fn&gt;</code></pre>
<p>Now we can modeling each data category with each model</p>
<pre class="r"><code>nested.multi &lt;- nested.multi %&gt;% 
  mutate(param = map2(train.x, train.y, ~list(.x, .y)),
         model = invoke_map(model,param))
nested.multi</code></pre>
<pre><code>#&gt; # A tibble: 8 x 7
#&gt;   checking_balance rawdata     train.x     train.y   modelName model param 
#&gt;   &lt;fct&gt;            &lt;list&gt;      &lt;list&gt;      &lt;list&gt;    &lt;chr&gt;     &lt;lis&gt; &lt;list&gt;
#&gt; 1 &lt; 0 DM           &lt;tibble [2~ &lt;tibble [2~ &lt;fct [27~ rforest   &lt;tra~ &lt;list~
#&gt; 2 1 - 200 DM       &lt;tibble [2~ &lt;tibble [2~ &lt;fct [26~ rforest   &lt;tra~ &lt;list~
#&gt; 3 unknown          &lt;tibble [3~ &lt;tibble [3~ &lt;fct [38~ rforest   &lt;tra~ &lt;list~
#&gt; 4 &gt; 200 DM         &lt;tibble [6~ &lt;tibble [6~ &lt;fct [63~ rforest   &lt;tra~ &lt;list~
#&gt; 5 &lt; 0 DM           &lt;tibble [2~ &lt;tibble [2~ &lt;fct [27~ rpart     &lt;tra~ &lt;list~
#&gt; 6 1 - 200 DM       &lt;tibble [2~ &lt;tibble [2~ &lt;fct [26~ rpart     &lt;tra~ &lt;list~
#&gt; 7 unknown          &lt;tibble [3~ &lt;tibble [3~ &lt;fct [38~ rpart     &lt;tra~ &lt;list~
#&gt; 8 &gt; 200 DM         &lt;tibble [6~ &lt;tibble [6~ &lt;fct [63~ rpart     &lt;tra~ &lt;list~</code></pre>
<pre class="r"><code>nested.multi$model[[1]]$finalModel</code></pre>
<pre><code>#&gt; 
#&gt; Call:
#&gt;  randomForest(x = x, y = y, mtry = param$mtry, trContrl = ..1) 
#&gt;                Type of random forest: classification
#&gt;                      Number of trees: 500
#&gt; No. of variables tried at each split: 8
#&gt; 
#&gt;         OOB estimate of  error rate: 37.78%
#&gt; Confusion matrix:
#&gt;     no yes class.error
#&gt; no  85  51    0.375000
#&gt; yes 51  83    0.380597</code></pre>
<p>And we can see the accuracy each model</p>
<pre class="r"><code>nested.multi &lt;- nested.multi %&gt;% 
  mutate(Accuracy = map_dbl(model, ~max(.x$results$Accuracy)))</code></pre>
<pre class="r"><code>library(lime)

model_result &lt;- lime(x = nested.multi$train.x[[1]],nested.multi$model[[1]])
model_result$bin_continuous</code></pre>
<pre><code>#&gt; [1] TRUE</code></pre>
</div>
</div>

  </div>

  <footer>
    <ul class="stats">
  <li class="categories">
    <ul>
        
            
            
                <i class="fa fa-folder"></i>
                
                
                <li><a class="article-category-link" href="/categories/r">R</a></li>
                
            
        
    </ul>
  </li>
  <li class="tags">
    <ul>
        
            
            
                <i class="fa fa-tags"></i>
                
                
                <li><a class="article-category-link" href="/tags/data-manipulation">Data Manipulation</a></li>
                
                
                <li><a class="article-category-link" href="/tags/tidyverse">tidyverse</a></li>
                
                
                <li><a class="article-category-link" href="/tags/capstone-ml">Capstone Ml</a></li>
                
            
        
    </ul>
  </li>
</ul>

  </footer>

</article>

    <article class="post">
        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "https-algotech-netlify-com" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </article>


<ul class="actions pagination">
    
        <li><a href="/blog/troubleshoot-in-r/"
                class="button big previous">Troubleshoot in R</a></li>
    

    
        <li><a href="/blog/metrics-evaluation-using-yardstick/"
                class="button big next">Metrics Evaluation using `yardstick`</a></li>
    
</ul>


    </div>
    
<section id="sidebar">

  
  <section id="intro">
    
    
      
        <a href='/'><img src="/img/main/logo.png" class="intro-circle" width="30%" alt="Hugo Future Imperfect" /></a>
      
    
    
      <header>
        <h2>Algoritma Technical Blog</h2>
        <p>We're a group of people who teach data science to individuals, trains companies and their employees to better profit from data. We care about the development of data science and a sense of community that connects our alumni and team with one another. To learn more about our approach to data science problems, feel free to hop over to our blog.</p>
      </header>
    
    
      <ul class="icons">
        
        
  <li><a href="//github.com/teamalgoritma" target="_blank" title="GitHub" class="fa fa-github"></a></li>



























  <li><a href="//linkedin.com/company/teamalgoritma" target="_blank" title="LinkedIn Company" class="fa fa-linkedin"></a></li>









  <li><a href="//facebook.com/teamalgoritma" target="_blank" title="Facebook" class="fa fa-facebook"></a></li>





















  <li><a href="//instagram.com/teamalgoritma" target="_blank" title="Instagram" class="fa fa-instagram"></a></li>





  <li><a href="//twitter.com/teamalgoritma" target="_blank" title="Twitter" class="fa fa-twitter"></a></li>




















      </ul>
    
  </section>



  
  
  

  
  

  
  <section id="footer">
    <p class="copyright">
      
        &copy; 2019
        
          Algoritma Technical Blog
        
      .
      Powered by <a href="//gohugo.io" target="_blank">Hugo</a>
    </p>
  </section>
</section>

    </div>
    <a id="back-to-top" href="#" class="fa fa-arrow-up fa-border fa-2x"></a>
    

    
      
    

    
      
      
      
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/highlight.min.js"></script>
        
        
        
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/r.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/yaml.min.js"></script>
        <script src="//cdn.bootcss.com/highlight.js/9.11.0/languages/css.min.js"></script>
        <script>hljs.configure({languages: []}); hljs.initHighlightingOnLoad();</script>
      
    
    
    
      <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/skel/3.0.1/skel.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.1.25/jquery.fancybox.min.js"></script>
      <script src="/js/util.js"></script>
      <script src="/js/main.js"></script>
      <script src="/js/backToTop.js"></script>
    

    
      
        
      
        
          <script src="/js/bootstrap.min.js"></script>
        
      
    

    
    <script>hljs.initHighlightingOnLoad();</script>
      <script src="//yihui.name/js/math-code.js"></script>
<script async
src="//cdn.bootcss.com/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML">
</script>


  </body>
</html>

